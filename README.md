# 联盟链

## 随机生成账号

### 第一个

```
subkey generate --scheme Sr25519 --password-interactive
Secret phrase:       attract broken prize foam expand clog scene net put broccoli whip bar
  Network ID:        substrate
  Secret seed:       0x7f97b4ac88cb629402cca06a69bb0eb67590d023e5fec1b0f219ff1d41dd9589
  Public key (hex):  0x7a37a1689bdf29ee90cffe2f9168993221d650750ba5b61ede9bc5fa7f61144f
  Account ID:        0x7a37a1689bdf29ee90cffe2f9168993221d650750ba5b61ede9bc5fa7f61144f
  Public key (SS58): 5EpxDzVtmm9SsXH9TuksJyKy4TmcPSpw3Ao7nPdVSRUujPyN
  SS58 Address:      5EpxDzVtmm9SsXH9TuksJyKy4TmcPSpw3Ao7nPdVSRUujPyN

subkey inspect --password-interactive --scheme Ed25519 "attract broken prize foam expand clog scene net put broccoli whip bar"
Secret phrase:       attract broken prize foam expand clog scene net put broccoli whip bar
  Network ID:        substrate
  Secret seed:       0x7f97b4ac88cb629402cca06a69bb0eb67590d023e5fec1b0f219ff1d41dd9589
  Public key (hex):  0xbef30ffbbc9e5477085bd1b3ba050d1d8b2a90798f72db3d5e408fa772ddd309
  Account ID:        0xbef30ffbbc9e5477085bd1b3ba050d1d8b2a90798f72db3d5e408fa772ddd309
  Public key (SS58): 5GP5AE63KXmwcXeKcudUpWibXHGxU5gtAfFsaSnFjtX4yB5f
  SS58 Address:      5GP5AE63KXmwcXeKcudUpWibXHGxU5gtAfFsaSnFjtX4yB5f
```

### 其余三个

```
Secret phrase:       garment calm oppose urban genre mango hobby brown scrub admit item globe
  Network ID:        substrate
  Secret seed:       0x55468d5b72d617bd46b2f2a0c962e00d7142bc854e04680f35751b4bd763a3ae
  Public key (hex):  0x3e7d28a354a9a2b720a785788cba777882e0ef20d797e50cc00adb1f4f467f3f
  Account ID:        0x3e7d28a354a9a2b720a785788cba777882e0ef20d797e50cc00adb1f4f467f3f
  Public key (SS58): 5DUe1JBcPM9kLVcfXQhSdJqETKx3USdDH4nrgRCL3NkT33vW
  SS58 Address:      5DUe1JBcPM9kLVcfXQhSdJqETKx3USdDH4nrgRCL3NkT33vW

subkey inspect --password-interactive --scheme Ed25519 "garment calm oppose urban genre mango hobby brown scrub admit item globe"
Secret phrase:       garment calm oppose urban genre mango hobby brown scrub admit item globe
  Network ID:        substrate
  Secret seed:       0x55468d5b72d617bd46b2f2a0c962e00d7142bc854e04680f35751b4bd763a3ae
  Public key (hex):  0xcb76dc10cfc3fae1750c57d26dfa6799041445e943430de9123ce2afda81742f
  Account ID:        0xcb76dc10cfc3fae1750c57d26dfa6799041445e943430de9123ce2afda81742f
  Public key (SS58): 5GfUtNEy5bcqyPj5B1mX5GAPb8CvMkbjzxtWyBMHi38kWPJr
  SS58 Address:      5GfUtNEy5bcqyPj5B1mX5GAPb8CvMkbjzxtWyBMHi38kWPJr

Secret phrase:       thunder black neglect brush van slam question adapt blush debate piece chair
  Network ID:        substrate
  Secret seed:       0x6d3c76ed936d94a6ee005250b128d43a26e7cdac7db1d115c03c8eb5c6b8b0cc
  Public key (hex):  0xbec06d51fe564cd15685c87aeb6fcd498093acdee960f8cdc8a4d3bbcbc40d5b
  Account ID:        0xbec06d51fe564cd15685c87aeb6fcd498093acdee960f8cdc8a4d3bbcbc40d5b
  Public key (SS58): 5GNp7oHLi3V4hdrPEDNmt6WzQuZMve5Rk8yjWvYrLQ9HGSF2
  SS58 Address:      5GNp7oHLi3V4hdrPEDNmt6WzQuZMve5Rk8yjWvYrLQ9HGSF2
subkey inspect --password-interactive --scheme Ed25519 "thunder black neglect brush van slam question adapt blush debate piece chair"
Secret phrase:       thunder black neglect brush van slam question adapt blush debate piece chair
  Network ID:        substrate
  Secret seed:       0x6d3c76ed936d94a6ee005250b128d43a26e7cdac7db1d115c03c8eb5c6b8b0cc
  Public key (hex):  0x2e7d63f0c0617e083e8d81a608613bd68667f10a9f52743d77fec5d9e9a1d92e
  Account ID:        0x2e7d63f0c0617e083e8d81a608613bd68667f10a9f52743d77fec5d9e9a1d92e
  Public key (SS58): 5D7fJrL3n66rMVr2Tf4nKpwSZdmKGiCRUj1tGviPxAFbmiDR
  SS58 Address:      5D7fJrL3n66rMVr2Tf4nKpwSZdmKGiCRUj1tGviPxAFbmiDR

Secret phrase:       omit tenant festival suggest dutch host shallow shoulder sort protect excess end
  Network ID:        substrate
  Secret seed:       0x909cdd4ed7bd324d8e7245e1d9ba990df82deee3e08e641655e092ca9448dd21
  Public key (hex):  0xa6e1e0bfd1026295fb0f6aa87a54778cbbf649c3d465b45db07cdfb896713c74
  Account ID:        0xa6e1e0bfd1026295fb0f6aa87a54778cbbf649c3d465b45db07cdfb896713c74
  Public key (SS58): 5FqWuVJTDyLpzT54qQNGgjrYXnVVicFfYNNsnkFEKrzBM7ec
  SS58 Address:      5FqWuVJTDyLpzT54qQNGgjrYXnVVicFfYNNsnkFEKrzBM7ec
subkey inspect --password-interactive --scheme Ed25519 "omit tenant festival suggest dutch host shallow shoulder sort protect excess end"
Secret phrase:       omit tenant festival suggest dutch host shallow shoulder sort protect excess end
  Network ID:        substrate
  Secret seed:       0x909cdd4ed7bd324d8e7245e1d9ba990df82deee3e08e641655e092ca9448dd21
  Public key (hex):  0x6456965a7c62a7808d092765debb01c75bef1f387a059f784e9bcd912a4df833
  Account ID:        0x6456965a7c62a7808d092765debb01c75bef1f387a059f784e9bcd912a4df833
  Public key (SS58): 5ELGNGK37FeKy5sagJ26KxE2XwDbANk2A7fRXwbJpMg9idiH
  SS58 Address:      5ELGNGK37FeKy5sagJ26KxE2XwDbANk2A7fRXwbJpMg9idiH
```

## 生成 node 节点的 密钥和 peerID

- subkey generate-node-key
- 解码 peerID https://whisperd.tech/bs58-codec/

| 账户 | 节点密钥                                                         | PeerId                                               | Decoded PeerID in hex                                                        |
| ---- | ---------------------------------------------------------------- | ---------------------------------------------------- | ---------------------------------------------------------------------------- |
| 1    | 2771a6fb1ee93a39773f4f26715966cad41db0d843c8e60f48b9e2cadf6b5906 | 12D3KooWS1bPAhtw8Rq7fi86sxAbSn8FygbtrEFqmc2cdwpkSbdW | 002408011220f09b523170f609580ec0a35e19fe8db8c79cc32b8fb67b3b7c51e3212d1f7385 |
| 2    | 84decb33517c08018d8c7a18b597a5d8a2ce4cfe57d2ce1e97774da1368bb6a4 | 12D3KooWSF9KBXnESAVvd8p7pmZpYi4ykmVwHYYqWcp6SR5dckwE | 002408011220f413f9f53b2990661382e262028666f3c26ac19c35c7b1a43cad0bc425577d0d |
| 3    | e4e6a2fe748c955b7306edfbe00c9868e7eab2b919427188dfe4bedb2de1d57c | 12D3KooWRgMZq9SMvrAgJAyHjjRExG14MXpbqWQYXSk7c8vJe293 | 002408011220ebada9e91ff135d71f47fa3c4daf336fc569db64baf04999ed768998bf11b22e |
| 4    | 05e36c497df61895ca7a3a548dcaf475d22edc070416b910dba13b6b15d07888 | 12D3KooWS3kx9oMGpBupCpyXCsJFB1UgPdAdU6Mw7DWnPP3nsa5y | 002408011220f1294d52c768ebe73f54b9adfb3a022c0f4676a98fc2c67f541928ae07e2b524 |

## 添加 pallet-node-authorization (runtime/Cargo.toml)

```
[dependencies]
pallet-node-authorization = { default-features = false, version = "4.0.0-dev", git = "https://github.com/paritytech/substrate.git", branch = "polkadot-v0.9.27" }

[features]
std = [
 "pallet-node-authorization/std",    # add this line
]
```

## 添加管理规则(runtime/src/lib.rs)

> 配置 pallet-node-authorization 使用 EnsureRoot 特权方法, Sudo pallet 可调用的.
> Sudo 托盘默认包含在节点模板中，使您能够通过 root 级管理帐户进行调用。在生产环境中，您将使用更现实的基于治理的检查。

## 为托盘实现 Config 特征(runtime/src/lib.rs)

```
use frame_system::EnsureRoot;
impl pallet_node_authorization::Config for Runtime {
	type Event = Event;
	type MaxWellKnownNodes = ConstU32<8>;
	type MaxPeerIdLength = ConstU32<128>;
	type AddOrigin = EnsureRoot<AccountId>;
	type RemoveOrigin = EnsureRoot<AccountId>;
	type SwapOrigin = EnsureRoot<AccountId>;
	type ResetOrigin = EnsureRoot<AccountId>;
	type WeightInfo = ();
}

construct_runtime!(
  NodeAuthorization: pallet_node_authorization::{Pallet, Call, Storage, Event<T>, Config<T>},
});
```

## 为授权节点添加创世存储(node/Cargo.toml)

> PeerId 以 bs58 格式编码，因此您需要在 node/Cargo.toml 中添加 bs58 库依赖项来解码 PeerId 以获取其字节。

```
[dependencies]
bs58 = { version = "0.4.0" }
```

## 创世存储添加有权加入网络的节点(node/src/chain_spec.rs)

```
use sp_core::OpaquePeerId; // A struct wraps Vec<u8>, represents as our `PeerId`.
use node_template_runtime::NodeAuthorizationConfig; // The genesis config that serves for our pallet.

GenesisConfig 初始化默认已授权的 PeerID
node_authorization: NodeAuthorizationConfig {
  nodes: vec![
    (
      OpaquePeerId(bs58::decode("12D3KooWS1bPAhtw8Rq7fi86sxAbSn8FygbtrEFqmc2cdwpkSbdW").into_vec().unwrap()),
      endowed_accounts[0].clone()
    ),
    (
      OpaquePeerId(bs58::decode("12D3KooWSF9KBXnESAVvd8p7pmZpYi4ykmVwHYYqWcp6SR5dckwE").into_vec().unwrap()),
      endowed_accounts[1].clone()
    ),
  ],
},
```

## check

`cargo check -p node-template-runtime`

## 启动网络

### 自定义链规范

- 基于 local 链规范修改
```
node/src/chain_spec.rs
复制并修改 fn local_testnet_config -> fn custom_testnet_config

pub fn custom_testnet_config() -> Result<ChainSpec, String> {
	let wasm_binary = WASM_BINARY.ok_or_else(|| "Development wasm not available".to_string())?;

	Ok(ChainSpec::from_genesis(
		"Custom Testnet", // Name
		"custom_testnet", // ID
		ChainType::Local,
		move || {
			testnet_genesis(
				wasm_binary,
				// Initial PoA authorities
				vec![authority_keys_from_seed("Alice"), authority_keys_from_seed("Bob")],
				// Sudo account
				get_account_id_from_seed::<sr25519::Public>("Alice"),
				// Pre-funded accounts
				vec![
					get_account_id_from_seed::<sr25519::Public>("Alice"),
					get_account_id_from_seed::<sr25519::Public>("Bob"),
					get_account_id_from_seed::<sr25519::Public>("Charlie"),
					get_account_id_from_seed::<sr25519::Public>("Dave"),
					get_account_id_from_seed::<sr25519::Public>("Eve"),
					get_account_id_from_seed::<sr25519::Public>("Ferdie"),
					get_account_id_from_seed::<sr25519::Public>("Alice//stash"),
					get_account_id_from_seed::<sr25519::Public>("Bob//stash"),
					get_account_id_from_seed::<sr25519::Public>("Charlie//stash"),
					get_account_id_from_seed::<sr25519::Public>("Dave//stash"),
					get_account_id_from_seed::<sr25519::Public>("Eve//stash"),
					get_account_id_from_seed::<sr25519::Public>("Ferdie//stash"),
				],
				true,
			)
		},
		// Bootnodes
		vec![],
		// Telemetry
		None,
		// Protocol ID
		None,
		// Properties
		None,
		None,
		// Extensions
		None,
	))
}
```
- 新增 --chain custom 匹配参数
```
node/src/command.rs -> fn load_spec

"custom" => Box::new(chain_spec::custom_testnet_config()?),
```
